<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>图书借阅</title>
		 <link rel="stylesheet" type="text/css" href="css/qian/public.css"/>
		<link rel="stylesheet" type="text/css" href="css/qian/index.css"/>
		<link rel="stylesheet" type="text/css" href="css/qian/lend.css"/> 
			<link href="css/jquery-ui/jquery-ui.css" rel="stylesheet" type="text/css">
		<link href="css/H-ui.min.css" rel="stylesheet" type="text/css" />
		<link href="css/H-ui.admin.css" rel="stylesheet" type="text/css" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<link href="lib/Hui-iconfont/1.0.1/iconfont.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
		<!--导航栏-->
		<div class="header w">
			<div class="logo">
				<img class="logo-pic1" src="images/qian/logo.png" />
				<img class="logo-pic2" src="images/qian/lg.png" />
			</div>
			<div class="nav clearfix">
				<ul>
					<li>
						<a href="libraryIndex.shtml" id="libraryIndex">首页</a>
					</li>
					<li>
						<a href="libraryNewbooks.shtml" id="libraryNewbooks">新书推荐</a>
					</li>
					<li>
						<a href="libraryLend.shtml" id="libraryLend">图书借阅</a>
					</li>
					<li>
						<a href="libraryList.shtml" id="libraryList">图书排行</a>
					</li>
					<li>
						<a href="libraryBorrowInfo.shtml" id="libraryPerson">个人中心</a>
					</li>
				</ul>
			</div>
		</div>
		<!--banner-->
		<div class="w">
			<img src="images/qian/banner.jpg" />
		</div>
		<!--位置条-->
		<div class="place w">
			<div class="place-w">
				<img src="images/qian/weizhi.png" />
				<span>当前位置：<a href="libraryIndex.shtml">首页</a>→图书借阅</span>
			</div>
		</div>
		<!--搜索框-->
		<div class="loan-search w">
			<div class="search-box">
				<p>借阅详情</p>
				<!-- 条件查找的div start -->
	      <div class="text-c top-searchbox2" id="searchform">  
           <table border="0" cellpadding="0" cellspacing="0" class="top_sbox" style="width: 80%;">
             <tr>
               
               
               
               <th style="width:60px;"> 图书名：</th>
                <td style="width:140px;"><input type="text"  value="" placeholder="" id="bookName" name="bookName"  class="input-text m_r10" onkeyup="this.value=this.value.replace(' ','')"/></td>
                <input type="hidden" id="userId" name="userId" >
                
               <th style="width:60px;"> 编号：</th>
                <td style="width:140px;"><input type="text"  value="" placeholder="" id="bookNo" name="bookNo"  class="input-text m_r10" onkeyup="this.value=this.value.replace(' ','')"/></td>
                
               
               
                <th style="width:60px;">书籍状态：</th>
               <td style="width:200px;">
               <span class="select-box inline" style="width:100%;margin-right:10px;*border:none;">
				    <select name="bookStatusId" id="bookStatusId" class="select"  style="width:100%">
					 <option value="">全部</option>
				    </select>
				</span>	
				
               </td>

               <td><button name="btnSearch" id="btnSearch" class="btn btn-success btn-radius" type="button" onClick="search();">查询</button></td>
             </tr>
           </table>
       </div>		   
	  	
	<!-- 条件查找的div end -->
			</div>
		</div>
		<!--搜索结果-->
		<div class="lend-result w">
			<p class="lend-result-p1">搜索结果</p>
			<div class="lend-result-top">
				 <table class="newBooks-tab" cellspacing="" cellpadding="">
						
							<tr class="text-c">
								<td>图书编号</td>
								<td>图书名称</td>
								<td>借阅时间</td>
								<td>应该归还时间</td>
								<td>借阅状态</td>
								<td>实际归还时间</td >
								<td>操作 </td >
							</tr>
							
						
					  <tbody id="pagingShowContainer">
						 
					  </tbody>
					</table>
				 <table style="margin-top: 10px;margin-left: 5px">
					<tr>
						<td align="left" id="countContainer">总 0 条  每页5 条  共 1 页</td>
						<td align="right" id="pagingIndexContainer" style="padding-left: 180px;"></td>
					</tr>
				</table>
			</div>
			
		</div>
		<!--底部区域-->
		<div class="down">
			<div class="down-tel w">
				<p>图书馆地址：河北省石家庄市新乐市空港工业园区无繁路69号</p>
				<p>联系方式：0311-888888888</p>
				<p>版权信息：Copyright © 图书馆</p>
				<p>技术支持:李素杰</p>
			</div>
		</div>
	</body>
		
		
		 <script type="text/javascript" src="/lib/uploadify/jquery.uploadify.js" ></script>
		<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script> 
		<script type="text/javascript" src="lib/layer/1.9.3/layer.js"></script> 
		<script type="text/javascript" src="lib/My97DatePicker/WdatePicker.js"></script> 
		<script type="text/javascript" src="lib/datatables/1.10.0/jquery.dataTables.min.js"></script> 
		<script type="text/javascript" src="js/H-ui.js"></script> 
		<script type="text/javascript" src="js/H-ui.admin.js"></script>
		<script type="text/javascript" src="js/json2.js" ></script>
        <script type="text/javascript" src="js/jquery-ui.js"></script>
        <script type="text/javascript" src="js/mask.js"></script>
        <script type="text/javascript" src="js/httpRequest.js" ></script>
        <script type="text/javascript" src="js/zcefUtils.js" ></script>
        <script src="js/public.js" type="text/javascript" charset="utf-8"></script>
		<!-- 分页模板引擎 -->
		<script type="text/javascript" src="lib/laytpl/laytpl.js"></script>
		<!-- 分页组件 -->
		<script type="text/javascript" src="lib/laypage/1.3/laypage.js"></script>  
		<!-- 分页模板引擎 -->
		<script type="text/javascript" src="lib/laytpl/laytpl.js"></script>
		<!-- 分页组件 -->
		<script type="text/javascript" src="lib/laypage/1.3/laypage.js"></script>  
		
		<!-- 第一步：编写模版。你可以使用一个script标签存放模板，如： -->
		<script id="pageTemplate" type="text/html">
			{{# for(var i = 0, len = d.pageList.length; i < len; i++){ }}
		      <tr class="text-c text-w newBooks-tr">
                 
				<td>{{ d.pageList[i].bookNo}}</td>
				<td>{{ d.pageList[i].bookName}}</td>
				<td>{{ d.pageList[i].borrowDate}}</td>
				<td>{{ d.pageList[i].returnTime}}</td>
				<td>{{ d.pageList[i].bookStatus}}</td>
				<td>{{ d.pageList[i].returnDateInfo==null?"无":d.pageList[i].returnDateInfo}}</td>
				<td >

                     {{#if( d.pageList[i].bookStatusId==1   ){ }}
  							  <a title="续借" href="javascript:;" onclick="xujie('{{d.pageList[i].id}}','{{d.pageList[i].returnTime}}')" class="ml-5" style="text-decoration:none"><i class="Hui-iconfont"><u></u></i>续借</a>
					       
					  {{# } }} 
 
                      {{#if( d.pageList[i].bookStatusId!=1   ){ }}
  							  
					          <a  href="javascript:;"  class="ml-5" style="text-decoration:none"><i class="Hui-iconfont"><u></u></i>暂无操作</a>
					  {{# } }} 

				</td>
			</tr>
            
			{{# } }}
		</script>
	
		 <script type="text/javascript">
		 
		 //个人中心,先从后台获取当前登录用户的信息 ,并且查找 
		 function getLoginUserInfo(){
			 var httpRequest = new HTTPRequest({
					url : "user/getLoginUser.ajax",
					successFunc : function (data) {
						if(data!=null){ 	
						
							 $("#userId").val(data.id);
							 var userId=$("#userId").val();
							 if(userId!=null&&userId!=""){
								 search(); 
							 }
							 return true;
						}else if(data==null){
							window.location.href="login.shtml";
							return false;
						}
			        }
				});
			
				httpRequest.sendJSON();
			 
		 }
		 
		 
		 $(function(){
			    getLoginUserInfo()
				selectAllBooksType();
				selectAllBooksStatus()
		
			}); 
		 
			//查询全部图书类别
			function selectAllBooksType(){
					var httpRequest = new HTTPRequest({
						url : "books/selectAllBooksType.ajax",
						successFunc : function (data) {
							if(data!=null){ 	
								$.each(data, function(i,n) {
									
			 						   $("#bookTypeId").append('<option value="'+data[i].id+'">'+data[i].type+"</option>");
			                        });
							}
				        }
					});
				
					httpRequest.sendJSON();

			}
			
			
			//查询用户借书的所有书籍状态  
			function selectAllBooksStatus(){
					var httpRequest = new HTTPRequest({
						url : "books/selectAllBooksStautus.ajax",
						successFunc : function (data) {
							if(data!=null){ 	
								$.each(data, function(i,n) {
									
			 						   $("#bookStatusId").append('<option value="'+data[i].id+'">'+data[i].status+"</option>");
			                        });
							}
				        }
					});
				
					httpRequest.sendJSON();

			}
			
			//模糊查询
		     function search(){
		    	 var userId=$("#userId").val();  
		    	 var bookName=$("#bookName").val();
		         var bookNo=$("#bookNo").val();
		         var bookStatusId=$("#bookStatusId").val();
		    	 if((userId!=""&&userId!=null)||(bookName!=""&&bookName!=null)||(bookNo!=""&&bookNo!=null)||(bookStatusId!=""&&bookStatusId!=null)){
		    		 $("#searchform").find("#userId").val(userId);
		    		 $("#searchform").find("#bookName").val(bookName);
		    		 $("#searchform").find("#bookNo").val(bookNo);
		    		 $("#searchform").find("#bookStatusId").val(bookStatusId);
		    		 var pgObjSearch = new Object();
	        		 pgObjSearch.sqlStatement = "mapper.BooksBorrowMapper.querySearchByPage";  
	        		 pgObjSearch.pageTemplate="pageTemplate";  //js读取后台数据的模板ID 
	        		 pgObjSearch.paramContainer = "searchform";// 指定查询参数  ..
	        		 pgObjSearch.showContainer="pagingShowContainer"; //指定查询哪个表格 
					 pagingShowContainer : "pagingShowContainer";//分页数据呈现的容器ID
					 pagingIndexContainer : "pagingIndexContainer";//分页索引呈现的容器ID,比如：首页、上一页、下一页、尾页显示的地方
					 countContainer : "countContainer";//分页统计数呈现的容器ID,比如：总记录条数、总共多少页显示的地方
					 ZcefUtils.pagingQuery(pgObjSearch); 
		    	 }else{
		    		 paging();
		    	 }
		     }
			
			
			// 续借逻辑 ,在原来的应该归还日期上加30天 , 参数1: 借阅表id ,参数2:应该归还时间
		    function xujie(id,returnTime){
		   	  if(id!= null && id !="" &&returnTime!=null&&returnTime!=""){
					ZcefUtils.confirmLayerWithResult({
						url:"booksBorrow/xujie.ajax",
						tipsMessage:"是否确定续借30天?",
							param:{id:id,returnTime:returnTime},
							afterFunc:function (result){
								if(result==1){
									layer.msg('续借成功 ！', {
									    icon: 1,
									    time: 1000
									}, function(){
										     getLoginUserInfo()
											
									}); 
								}
							} 
							
						});	
				}
		    }
				
		 
		 </script>	
</html>
